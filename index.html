<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Loftin Wealth Partners â€” Investment Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Cormorant+Garamond:wght@400;500;600;700&family=Raleway:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --bg:        #eef2f6;
    --surface:   #ffffff;
    --surface2:  #f4f7fa;
    --surface3:  #e8eef5;
    --border:    #c0d0e0;
    --navy:      #0d3349;
    --steel:     #4a7fa5;
    --blue:      #1a5f8a;
    --lightblue: #4a7fa5;
    --gold:      #7a5a00;
    --red:       #a82030;
    --green:     #147040;
    --text:      #0a2538;
    --muted:     #4a6a82;
    --dim:       #c8d4e0;
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Raleway', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content:'';
    position:fixed; top:0; left:0; right:0; bottom:0;
    background:
      radial-gradient(ellipse 80% 50% at 0% 0%, rgba(74,127,165,0.07) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 100% 100%, rgba(13,51,73,0.04) 0%, transparent 60%);
    pointer-events:none; z-index:0;
  }

  /* â”€â”€ TICKER â”€â”€ */
  .scroll-ticker {
    font-family:'DM Mono',monospace; font-size:13px; color:var(--muted);
    border-bottom:1px solid var(--border); padding:9px 0;
    overflow:hidden; white-space:nowrap;
    background:rgba(238,242,246,0.95);
  }
  .scroll-ticker-inner { display:inline-block; animation:scrollTicker 32s linear infinite; }
  .scroll-ticker-inner span { margin:0 36px; }
  .t-pos { color:var(--green); }
  .t-neg { color:var(--red); }
  @keyframes scrollTicker { from{transform:translateX(0)} to{transform:translateX(-50%)} }

  /* â”€â”€ HEADER â”€â”€ */
  header {
    display:flex; align-items:center; justify-content:space-between;
    padding:16px 32px;
    border-bottom:1px solid var(--border);
    background:rgba(255,255,255,0.97);
    backdrop-filter:blur(20px);
    position:sticky; top:0; z-index:100;
  }

  .logo { display:flex; align-items:center; gap:14px; }
  .logo-icon svg { width:44px; height:44px; }

  .logo-text { display:flex; flex-direction:column; }
  .logo-name {
    font-family:'Cormorant Garamond',serif;
    font-size:24px; font-weight:600; letter-spacing:3px;
    color:var(--text); line-height:1;
  }
  .logo-name em { font-style:normal; color:var(--blue); }
  .logo-tagline {
    font-family:'DM Mono',monospace; font-size:10px;
    letter-spacing:3px; color:var(--muted);
    margin-top:4px; text-transform:uppercase;
  }

  .header-meta {
    display:flex; align-items:center; gap:22px;
    font-family:'DM Mono',monospace; font-size:13px; color:var(--muted);
  }
  .live-dot {
    width:9px; height:9px; background:var(--green); border-radius:50%;
    animation:pulse 2s infinite; display:inline-block; margin-right:5px;
  }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(.8)} }

  .nav-links { display:flex; gap:5px; }
  .nav-btn {
    padding:7px 16px; font-family:'Raleway',sans-serif; font-size:13px;
    font-weight:600; letter-spacing:1px; border:1px solid var(--border);
    background:transparent; color:var(--muted); cursor:pointer;
    border-radius:3px; transition:all .2s;
  }
  .nav-btn.active, .nav-btn:hover {
    border-color:var(--blue); color:var(--blue);
    background:rgba(26,95,138,0.08);
  }

  /* â”€â”€ LAYOUT â”€â”€ */
  .main {
    position:relative; z-index:1;
    padding:22px 32px;
    display:grid;
    grid-template-columns:1fr 1fr 1fr 340px;
    grid-template-rows:auto auto auto auto;
    gap:16px;
  }

  /* â”€â”€ CARD â”€â”€ */
  .card {
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:8px; padding:20px;
    position:relative; overflow:hidden;
    animation:fadeUp .5s ease both;
  }
  .card::after {
    content:''; position:absolute; top:0; left:0; right:0; height:2px;
    background:linear-gradient(90deg, transparent, var(--navy), transparent);
    opacity:0; transition:opacity .3s;
  }
  .card:hover::after { opacity:.5; }
  @keyframes fadeUp { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }
  .card:nth-child(1){animation-delay:.05s} .card:nth-child(2){animation-delay:.1s}
  .card:nth-child(3){animation-delay:.15s} .card:nth-child(4){animation-delay:.2s}
  .card:nth-child(5){animation-delay:.25s} .card:nth-child(6){animation-delay:.3s}

  .card-label {
    font-size:12px; font-weight:700; letter-spacing:2px;
    color:var(--muted); text-transform:uppercase;
    margin-bottom:12px; display:flex; align-items:center; justify-content:space-between;
  }
  .badge {
    font-size:11px; padding:3px 10px; border-radius:20px;
    font-weight:700; letter-spacing:1px;
  }
  .b-green  { background:#d4f0e4; color:var(--green);    border:1px solid #a8ddc4; }
  .b-red    { background:#fde0e3; color:var(--red);      border:1px solid #f0a0a8; }
  .b-gold   { background:#fef3d0; color:var(--gold);     border:1px solid #e0c860; }
  .b-blue   { background:#ddeef8; color:var(--blue);     border:1px solid #a8cce0; }
  .b-muted  { background:#eaeff4; color:var(--muted);    border:1px solid #c0d0dc; }

  /* â”€â”€ STAT CARDS ROW â”€â”€ */
  .stat-cards {
    grid-column:1/4;
    display:grid; grid-template-columns:repeat(5,1fr); gap:16px;
  }
  .stat-value {
    font-family:'Cormorant Garamond',serif;
    font-size:40px; line-height:1; color:var(--text); margin-bottom:6px;
  }
  .stat-change {
    font-family:'DM Mono',monospace; font-size:14px;
    display:flex; align-items:center; gap:4px;
  }
  .pos { color:var(--green); }
  .neg { color:var(--red); }
  .stat-sparkline { margin-top:14px; height:38px; }

  /* â”€â”€ VIX â”€â”€ */
  .vix-meter { margin-top:12px; position:relative; }
  .vix-track {
    height:7px; border-radius:3px; position:relative; margin-bottom:6px;
    background:linear-gradient(90deg, #4aad84 0%, #c9a84c 42%, #d97040 68%, #d95f6b 100%);
  }
  .vix-needle {
    position:absolute; top:-5px; width:4px; height:17px;
    background:#fff; border-radius:2px; transform:translateX(-50%);
    box-shadow:0 0 5px rgba(0,0,0,.25);
    transition:left 1s cubic-bezier(.4,0,.2,1);
  }
  .vix-labels {
    display:flex; justify-content:space-between;
    font-family:'DM Mono',monospace; font-size:11px; color:var(--muted);
  }
  .vix-regime { margin-top:8px; font-size:12px; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; }

  /* â”€â”€ F&G ARC â”€â”€ */
  .fg-arc-wrap {
    position:relative; width:130px; height:70px; margin:10px auto 0;
  }
  .fg-arc-wrap canvas { position:absolute; top:0; left:0; }
  .fg-val {
    position:absolute; bottom:0; left:0; right:0;
    text-align:center; font-family:'Cormorant Garamond',serif;
    font-size:32px; line-height:1; pointer-events:none;
  }
  .fg-zone { text-align:center; font-size:13px; font-weight:700; letter-spacing:2px; text-transform:uppercase; margin-top:8px; }
  .fg-action {
    margin-top:8px; font-family:'DM Mono',monospace; font-size:11px;
    color:var(--muted); text-align:center; line-height:1.6;
    border-top:1px solid var(--border); padding-top:8px;
  }

  /* â”€â”€ PERF & BENCHMARK PANEL â”€â”€ */
  .perf-section { grid-column:1/4; grid-row:2; }
  .perf-table { width:100%; border-collapse:collapse; margin-top:8px; }
  .perf-table th { font-family:'DM Mono',monospace; font-size:12px; font-weight:700; letter-spacing:1.5px;
    color:var(--muted); text-transform:uppercase; text-align:right; padding:8px 12px; border-bottom:2px solid var(--border); }
  .perf-table th:first-child { text-align:left; }
  .perf-table td { font-family:'DM Mono',monospace; font-size:15px; padding:10px 12px;
    border-bottom:1px solid var(--border); text-align:right; vertical-align:middle; }
  .perf-table td:first-child { text-align:left; font-size:14px; font-weight:700; color:var(--text); }
  .perf-table tr:last-child td { border-bottom:none; }
  .perf-table tr.portfolio-row td { color:var(--blue); font-weight:700; }
  .perf-table .perf-loading { color:var(--muted); font-size:13px; }
  .perf-note { font-family:'DM Mono',monospace; font-size:11px; color:var(--muted); margin-top:10px;
    padding-top:8px; border-top:1px solid var(--border); letter-spacing:.3px; }
  canvas { width:100% !important; }

  /* â”€â”€ SIDEBAR â”€â”€ */
  .sidebar { grid-column:4; grid-row:1/5; display:flex; flex-direction:column; gap:16px; }

  /* â”€â”€ 5-QUADRANT â”€â”€ */
  .q-row {
    display:flex; align-items:flex-start; gap:10px; padding:11px 0;
    border-bottom:1px solid var(--border);
  }
  .q-row:last-child { border-bottom:none; }
  .q-badge {
    width:32px; height:32px; border-radius:4px; flex-shrink:0; margin-top:1px;
    display:flex; align-items:center; justify-content:center;
    font-size:12px; font-weight:800;
  }
  .q-name { font-size:14px; font-weight:700; }
  .q-role { font-family:'DM Mono',monospace; font-size:11px; color:var(--muted); margin-top:2px; }
  .d-ok    { color:#147040; }
  .d-warn  { color:#7a5a00; }
  .d-alert { color:#a82030; }

  /* â”€â”€ WATCHLIST â”€â”€ */
  .watch-item {
    display:flex; align-items:center; justify-content:space-between;
    padding:11px 0; border-bottom:1px solid var(--border);
    cursor:pointer; transition:all .15s;
  }
  .watch-item:hover { padding-left:4px; }
  .watch-item:last-child { border-bottom:none; }
  .w-sym  { font-size:15px; font-weight:700; }
  .w-name { font-family:'DM Mono',monospace; font-size:12px; color:var(--muted); }
  .w-price{ font-family:'DM Mono',monospace; font-size:15px; font-weight:500; }
  .w-chg  { font-family:'DM Mono',monospace; font-size:13px; }

  /* â”€â”€ HOLDINGS TABLE â”€â”€ */
  .holdings-section { grid-column:1/4; grid-row:3; }
  table { width:100%; border-collapse:collapse; }
  thead th {
    font-size:12px; font-weight:700; letter-spacing:1.5px; color:var(--muted);
    text-transform:uppercase; padding:4px 10px 12px 10px;
    text-align:right; border-bottom:2px solid var(--border);
  }
  thead th:first-child { text-align:left; }
  tbody tr { border-bottom:1px solid var(--border); transition:background .15s; cursor:pointer; }
  tbody tr:hover { background:rgba(26,95,138,.05); }
  tbody tr:last-child { border-bottom:none; }
  td { padding:11px 10px; font-family:'DM Mono',monospace; font-size:14px; text-align:right; color:var(--text); }
  td:first-child { text-align:left; }
  .t-sym  { font-weight:700; font-size:15px; color:var(--text); }
  .t-name { font-family:'Raleway',sans-serif; font-size:12px; color:var(--muted); font-weight:400; }

  /* RS badges */
  .rs { display:inline-flex; align-items:center; padding:4px 10px; border-radius:4px; font-family:'DM Mono',monospace; font-size:13px; font-weight:800; letter-spacing:.4px; }
  .rs-buy  { background:#d4f0e4; color:#0f5c35; border:1px solid #a8ddc4; }
  .rs-add  { background:#e4f5ec; color:#1a7a4a; border:1px solid #b8e0cb; }
  .rs-hold { background:#fef6d8; color:#7a5500; border:1px solid #e8d080; }
  .rs-trim { background:#fdebd0; color:#8a4000; border:1px solid #f0b870; }
  .rs-sell { background:#fde0e3; color:#8a1a24; border:1px solid #f0a0a8; }

  /* â”€â”€ NEWS â”€â”€ */
  .news-section { grid-column:1/4; grid-row:4; }
  .news-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:14px; margin-top:6px; }
  .news-item { padding:14px; background:var(--surface); border:1px solid var(--border); border-radius:6px; cursor:pointer; transition:all .2s; box-shadow:0 1px 3px rgba(13,51,73,.06); }
  .news-item:hover { border-color:var(--steel); background:var(--surface2); }
  .news-src { font-size:11px; font-weight:700; letter-spacing:1.5px; color:var(--gold); text-transform:uppercase; margin-bottom:6px; }
  .news-hl  { font-size:14px; font-weight:600; line-height:1.5; color:var(--text); margin-bottom:6px; }
  .news-time{ font-family:'DM Mono',monospace; font-size:12px; color:var(--muted); }
  .news-tag { display:inline-block; font-size:11px; padding:3px 7px; border-radius:3px; font-weight:700; letter-spacing:1px; margin-right:4px; }
  .tag-bull { background:rgba(74,173,132,.12);  color:var(--green); }
  .tag-bear { background:rgba(217,95,107,.12);  color:var(--red); }
  .tag-neut { background:rgba(72,106,130,.12); color:var(--muted); }

  /* â”€â”€ CSV UPLOAD â”€â”€ */
  .upload-zone {
    border: 2px dashed var(--border);
    border-radius: 6px;
    padding: 18px 14px 14px;
    text-align: center;
    cursor: default;
    transition: all 0.2s;
    background: transparent;
    user-select: none;
  }
  .upload-zone.drag-over {
    border-color: var(--blue);
    background: rgba(91,158,201,0.07);
  }
  .upload-browse-btn {
    display: inline-block;
    margin-top: 10px;
    padding: 6px 18px;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 1px;
    color: var(--blue);
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
  }
  .upload-browse-btn:hover {
    border-color: var(--blue);
    background: rgba(91,158,201,0.1);
  }
  .upload-icon { font-size: 28px; margin-bottom: 8px; }
  .upload-title {
    font-size: 14px; font-weight: 700; letter-spacing: 1px;
    color: var(--text); margin-bottom: 4px;
  }
  .upload-sub {
    font-family: 'DM Mono', monospace; font-size: 12px; color: var(--muted); line-height: 1.6;
  }
  .upload-status {
    margin-top: 10px; padding: 10px 12px;
    border-radius: 4px; font-family: 'DM Mono', monospace;
    font-size: 12px; line-height: 1.6; display: none;
  }
  .upload-status.success { background: rgba(74,173,132,0.1); border: 1px solid rgba(74,173,132,0.2); color: var(--green); }
  .upload-status.error   { background: rgba(217,95,107,0.1); border: 1px solid rgba(217,95,107,0.2); color: var(--red); }
  .csv-format-hint {
    margin-top: 12px; padding: 10px 12px;
    border-radius: 4px; background: #eaeff4;
    font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted); line-height: 1.9;
  }
  .csv-format-hint strong { color: var(--blue); }
  .last-updated {
    font-family: 'DM Mono', monospace; font-size: 11px;
    color: var(--muted); text-align: right; margin-top: 8px;
    display: none;
  }
  /* â”€â”€ PRESENTATION MODE â”€â”€ */
  .present-toggle {
    padding:7px 18px; font-family:'DM Mono',monospace; font-size:12px;
    font-weight:700; letter-spacing:1px; border:2px solid var(--blue);
    background:rgba(26,95,138,0.08); color:var(--blue); cursor:pointer;
    border-radius:4px; transition:all .2s; text-transform:uppercase;
  }
  .present-toggle:hover { background:var(--blue); color:#fff; }
  body.presenting .present-toggle { background:var(--blue); color:#fff; }

  /* Client banner â€” only visible in presentation mode */
  .client-banner {
    display:none; text-align:center; padding:28px 32px 20px;
    background:var(--surface); border-bottom:2px solid var(--border);
  }
  .client-banner .client-name {
    font-family:'Cormorant Garamond',serif; font-size:32px; font-weight:600;
    color:var(--text); letter-spacing:2px;
  }
  .client-banner .client-sub {
    font-family:'DM Mono',monospace; font-size:13px; color:var(--muted);
    margin-top:6px; letter-spacing:1px;
  }

  /* Five Quadrant hero â€” only in presentation mode */
  .quadrant-hero {
    display:none; grid-column:1/-1;
  }
  .quadrant-hero .q-grid {
    display:grid; grid-template-columns:repeat(5,1fr); gap:16px;
  }
  .q-hero-card {
    background:var(--surface); border:1px solid var(--border); border-radius:8px;
    padding:20px 16px; text-align:center; position:relative; overflow:hidden;
  }
  .q-hero-card::before {
    content:''; position:absolute; top:0; left:0; right:0; height:4px;
  }
  .q-hero-badge {
    font-size:16px; font-weight:800; letter-spacing:1px; margin-bottom:6px;
  }
  .q-hero-name { font-size:14px; font-weight:700; color:var(--text); margin-bottom:2px; }
  .q-hero-role { font-family:'DM Mono',monospace; font-size:11px; color:var(--muted); margin-bottom:14px; }
  .q-hero-pct {
    font-family:'Cormorant Garamond',serif; font-size:38px; font-weight:600; line-height:1;
    margin-bottom:4px;
  }
  .q-hero-target { font-family:'DM Mono',monospace; font-size:12px; color:var(--muted); }
  .q-hero-status { font-family:'DM Mono',monospace; font-size:12px; font-weight:700; margin-top:10px; letter-spacing:.5px; }
  .q-hero-bar { margin:12px auto 0; width:80%; position:relative; height:6px; background:var(--dim); border-radius:3px; }

  /* Presentation mode body overrides */
  body.presenting .scroll-ticker { display:none; }
  body.presenting .nav-links { display:none; }
  body.presenting .client-banner { display:block; }
  body.presenting .sidebar { display:none; }
  body.presenting .news-section { display:none; }
  body.presenting .quadrant-hero { display:block; }

  body.presenting .main {
    grid-template-columns:1fr 1fr;
    grid-template-rows:auto auto auto auto;
  }
  body.presenting .stat-cards {
    grid-column:1/-1;
    grid-template-columns:repeat(5,1fr);
  }
  body.presenting .perf-section { grid-column:1/-1; grid-row:auto; }
  body.presenting .quadrant-hero { grid-column:1/-1; grid-row:auto; }
  body.presenting .holdings-section { grid-column:1/-1; grid-row:auto; }

  /* Bigger stat values in present mode */
  body.presenting .stat-value { font-size:48px; }
  body.presenting .stat-change { font-size:16px; }
  body.presenting .card-label { font-size:13px; }
  body.presenting .perf-table td { font-size:17px; padding:12px 14px; }
  body.presenting .perf-table td:first-child { font-size:15px; }
  body.presenting .perf-table th { font-size:13px; }
  body.presenting td { font-size:15px; padding:12px 10px; }
  body.presenting .t-sym { font-size:17px; }
  body.presenting .t-name { font-size:13px; }
  body.presenting .rs { font-size:14px; padding:5px 12px; }
  body.presenting thead th { font-size:13px; }
</style>
</head>
<body>

<!-- TICKER TAPE -->
<div class="scroll-ticker"><div class="scroll-ticker-inner" id="ticker"></div></div>

<!-- HEADER -->
<header>
  <div class="logo">
    <!-- LWP-inspired icon: arc + bars -->
    <div class="logo-icon">
      <svg viewBox="0 0 80 70" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M10 58 Q40 10 70 58" stroke="#4a7fa5" stroke-width="4" fill="none" stroke-linecap="round"/>
        <rect x="24" y="36" width="8" height="22" rx="1.5" fill="#0d2d45"/>
        <rect x="36" y="22" width="8" height="36" rx="1.5" fill="#4a7fa5"/>
        <rect x="48" y="30" width="8" height="28" rx="1.5" fill="#7db8da"/>
      </svg>
    </div>
    <div class="logo-text">
      <div class="logo-name">LOFTIN <em>WEALTH</em> PARTNERS</div>
      <div class="logo-tagline">Fiduciary Â· Process-Driven Â· Johns Creek, GA</div>
    </div>
  </div>
  <div class="header-meta">
    <span id="header-mkt"><span class="live-dot" id="header-dot"></span><span id="header-mkt-label">CHECKINGâ€¦</span></span>
    <span id="clock">--:--:--</span>
    <span>NYSE Â· NASDAQ Â· CBOE</span>
  </div>
  <div class="nav-links">
    <button class="nav-btn active">DASHBOARD</button>
    <button class="nav-btn">PORTFOLIO</button>
    <button class="nav-btn">MARKETS</button>
    <button class="nav-btn">ALERTS</button>
  </div>
  <button class="present-toggle" id="present-toggle" onclick="togglePresent()">â–¶ PRESENT</button>
</header>

<!-- CLIENT BANNER (visible in presentation mode only) -->
<div class="client-banner" id="client-banner">
  <div class="client-name" id="client-name">Portfolio Review</div>
  <div class="client-sub" id="client-sub">Loftin Wealth Partners Â· <span id="client-date"></span></div>
</div>

<div class="main">

  <!-- STAT CARDS -->
  <div class="stat-cards">
    <!-- Portfolio Value -->
    <div class="card">
      <div class="card-label">Portfolio Value <span class="badge b-muted" id="port-badge">DEMO DATA</span></div>
      <div class="stat-value" id="port-val">â€”</div>
      <div class="stat-change" id="port-change" style="color:var(--muted)">Upload holdings file to populate</div>
      <div class="stat-sparkline"><canvas id="sp1"></canvas></div>
    </div>
    <!-- Market Status -->
    <div class="card">
      <div class="card-label">Market Status <span class="badge b-muted" id="mkt-badge">CHECKING</span></div>
      <div class="stat-value" id="mkt-status" style="font-size:34px">â€”</div>
      <div class="stat-change" id="mkt-detail" style="color:var(--muted)">NYSE Â· NASDAQ Â· CBOE</div>
      <div style="margin-top:10px;font-family:'DM Mono',monospace;font-size:12px;color:var(--muted)" id="mkt-next"></div>
    </div>
    <!-- S&P 500 -->
    <div class="card">
      <div class="card-label">S&P 500 <span class="badge b-muted" id="spy-badge">LOADING</span></div>
      <div class="stat-value" id="spy-val" style="font-size:36px">â€”</div>
      <div class="stat-change" id="spy-change" style="color:var(--muted)">Fetching live dataâ€¦</div>
      <div class="stat-sparkline"><canvas id="sp2"></canvas></div>
    </div>
    <!-- VIX -->
    <div class="card">
      <div class="card-label">CBOE VIX <span class="badge b-muted" id="vix-badge">LOADING</span></div>
      <div class="stat-value" id="vix-val">â€”</div>
      <div class="stat-change" id="vix-change" style="color:var(--muted)">Fetching live dataâ€¦</div>
      <div class="vix-meter">
        <div class="vix-track"><div class="vix-needle" id="vix-needle" style="left:50%"></div></div>
        <div class="vix-labels"><span>CALM</span><span>NORM</span><span>FEAR</span><span>PANIC</span></div>
        <div class="vix-regime" id="vix-regime" style="color:var(--muted)">Loadingâ€¦</div>
      </div>
    </div>
    <!-- Fear & Greed -->
    <div class="card">
      <div class="card-label">Fear &amp; Greed <span class="badge b-muted" id="fg-badge">LOADING</span></div>
      <div class="fg-arc-wrap">
        <canvas id="fgArc" width="130" height="70"></canvas>
        <div class="fg-val" id="fg-val" style="color:var(--muted)">â€”</div>
      </div>
      <div class="fg-zone" id="fg-zone" style="color:var(--muted)">Loadingâ€¦</div>
      <div class="fg-action" id="fg-action">Fetching CNN Fear & Greed Indexâ€¦</div>
    </div>
  </div>

  <!-- PERFORMANCE & BENCHMARKS (unified) -->
  <div class="card perf-section">
    <div class="card-label">Performance & Benchmarks <span class="badge b-blue" id="perf-badge">UPLOAD TO POPULATE</span></div>
    <table class="perf-table" id="perf-table">
      <thead>
        <tr>
          <th style="text-align:left">Strategy / Index</th>
          <th>YTD</th>
          <th>1 Year</th>
          <th>2 Year</th>
          <th>3 Year</th>
          <th>5 Year</th>
        </tr>
      </thead>
      <tbody id="perf-tbody">
        <tr class="portfolio-row"><td>â–¶ LWP Portfolio</td><td>â€”</td><td>â€”</td><td>â€”</td><td>â€”</td><td>â€”</td></tr>
        <tr><td>MSCI ACWI</td><td class="perf-loading">â€¦</td><td class="perf-loading">â€¦</td><td class="perf-loading">â€¦</td><td class="perf-loading">â€¦</td><td class="perf-loading">â€¦</td></tr>
        <tr><td>S&P 500</td><td class="perf-loading">â€¦</td><td class="perf-loading">â€¦</td><td class="perf-loading">â€¦</td><td class="perf-loading">â€¦</td><td class="perf-loading">â€¦</td></tr>
        <tr><td>60/40 Blend</td><td class="perf-loading">â€¦</td><td class="perf-loading">â€¦</td><td class="perf-loading">â€¦</td><td class="perf-loading">â€¦</td><td class="perf-loading">â€¦</td></tr>
        <tr><td>Barclays Agg (AGG)</td><td class="perf-loading">â€¦</td><td class="perf-loading">â€¦</td><td class="perf-loading">â€¦</td><td class="perf-loading">â€¦</td><td class="perf-loading">â€¦</td></tr>
      </tbody>
    </table>
    <div class="perf-note" id="perf-note">Benchmark returns based on prior trading day close. Upload holdings file to populate LWP Portfolio row.</div>
  </div>

  <!-- FIVE QUADRANT HERO (presentation mode only) -->
  <div class="card quadrant-hero" id="quadrant-hero">
    <div class="card-label">Five Quadrant Allocation Model <span class="badge b-gold">YOUR PORTFOLIO</span></div>
    <div class="q-grid" id="q-hero-grid"></div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <!-- CSV Upload -->
    <div class="card">
      <div class="card-label">Import Holdings <span class="badge b-blue" id="upload-badge">CSV / XLSX</span><button id="clear-btn" onclick="clearUpload()" title="Clear uploaded data" style="display:none;margin-left:8px;background:none;border:1px solid var(--border);border-radius:3px;color:var(--muted);cursor:pointer;font-size:12px;padding:3px 9px;line-height:16px;font-family:'DM Mono',monospace;letter-spacing:.5px">âœ• clear</button></div>
      <div class="upload-zone" id="upload-zone">
        <div class="upload-icon">ðŸ“‚</div>
        <div class="upload-title">DRAG & DROP FILE HERE</div>
        <div class="upload-sub">Drop your .XLSX or .CSV holdings file<br>All data read from file â€” no internet required</div>
        <label for="csv-input" class="upload-browse-btn">or click to browse</label>
      </div>
      <input type="file" id="csv-input" accept=".xlsx,.xls,.csv" style="display:none">
      <div class="upload-status" id="upload-status"></div>
      <div class="csv-format-hint">
        <strong>Required columns:</strong><br>
        Ticker &nbsp;Â·&nbsp; Quadrant &nbsp;Â·&nbsp; Quantity &nbsp;Â·&nbsp; Price<br>
        <strong>Optional:</strong> RS Score (0â€“6)<br>
        <strong>Performance rows (below holdings):</strong><br>
        LWP YTD &nbsp;Â·&nbsp; LWP 1Y &nbsp;Â·&nbsp; LWP 3Y &nbsp;Â·&nbsp; LWP 5Y
      </div>
      <div class="last-updated" id="last-updated"></div>
    </div>
    <!-- Five Quadrant Model -->
    <div class="card">
      <div class="card-label">Five Quadrant Model <span class="badge b-gold">MOD. AGG.</span></div>
      <div id="quadrant-list"></div>
    </div>
    <!-- Watchlist -->
    <div class="card" style="flex:1">
      <div class="card-label">Watchlist <span class="badge b-muted">5 TRACKED</span></div>
      <div id="watchlist"></div>
    </div>
  </div>

  <!-- HOLDINGS -->
  <div class="card holdings-section">
    <div class="card-label">Holdings <span class="badge b-muted">AWAITING UPLOAD</span></div>
    <table>
      <thead><tr>
        <th>Asset</th><th>Quadrant</th><th>Weight</th><th>Price</th><th>Chg%</th><th>Value</th><th>RS</th><th>Action</th>
      </tr></thead>
      <tbody id="holdings-tbody"></tbody>
    </table>
  </div>

  <!-- NEWS -->
  <div class="card news-section">
    <div class="card-label">Market Intelligence <span class="badge b-gold">6 STORIES</span></div>
    <div class="news-grid" id="news-grid"></div>
  </div>

</div>

<script>
// â”€â”€ PRESENTATION MODE â”€â”€
let presentMode = false;

function togglePresent() {
  presentMode = !presentMode;
  document.body.classList.toggle('presenting', presentMode);
  document.getElementById('present-toggle').textContent = presentMode ? 'âœ• EXIT' : 'â–¶ PRESENT';
  if (presentMode) {
    // Set meeting date
    document.getElementById('client-date').textContent = new Date().toLocaleDateString('en-US', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
    // Build quadrant hero if we have data
    buildQuadrantHero();
  }
}

// Store last uploaded quadrant data for hero rendering
let lastQuadTotals = null;
let lastTotalValue = 0;

function buildQuadrantHero() {
  const grid = document.getElementById('q-hero-grid');
  const qDefs = [
    {k:'Q1', name:'Cash & Bonds',  role:'Preservation Â· Liquidity',    lo:1,  hi:5,  c:'#4a7fa5'},
    {k:'Q2', name:'Balanced',      role:'Income + Growth Anchor',       lo:10, hi:20, c:'#2d6a9f'},
    {k:'Q3', name:'Dividends',     role:'Income Â· Inflation Hedge',     lo:15, hi:25, c:'#1a7a4a'},
    {k:'Q4', name:'Growth',        role:'Capital Appreciation Engine',  lo:50, hi:60, c:'#0d3349'},
    {k:'Q5', name:'Alternatives',  role:'Low Correlation Â· Diversify',  lo:5,  hi:10, c:'#6b9fc2'},
  ];
  grid.innerHTML = '';
  qDefs.forEach(q => {
    const act = lastTotalValue > 0 && lastQuadTotals ? (lastQuadTotals[q.k] / lastTotalValue * 100) : 0;
    const actR = act > 0 ? act.toFixed(1) + '%' : 'â€”';
    const inBand = act >= q.lo && act <= q.hi;
    const nearEdge = inBand && (act - q.lo < 2 || q.hi - act < 2);
    const statusLabel = act === 0 ? 'NO DATA' : !inBand ? 'OUT OF BAND' : nearEdge ? 'NEAR EDGE' : 'IN BAND';
    const statusColor = act === 0 ? 'var(--muted)' : !inBand ? '#a82030' : nearEdge ? '#7a5a00' : '#147040';

    const barScale = 30;
    const barLeft = (q.lo / barScale * 100).toFixed(1);
    const barWidth = ((q.hi - q.lo) / barScale * 100).toFixed(1);
    const needle = act > 0 ? Math.min(Math.max((act / barScale * 100), 1), 99).toFixed(1) : -10;

    grid.innerHTML += `<div class="q-hero-card" style="border-top:4px solid ${q.c}">
      <div class="q-hero-badge" style="color:${q.c}">${q.k}</div>
      <div class="q-hero-name">${q.name}</div>
      <div class="q-hero-role">${q.role}</div>
      <div class="q-hero-pct" style="color:${q.c}">${actR}</div>
      <div class="q-hero-target">Target: ${q.lo}â€“${q.hi}%</div>
      <div class="q-hero-bar">
        <div style="position:absolute;left:${barLeft}%;width:${barWidth}%;height:100%;background:${q.c}35;border-radius:3px;border:1px solid ${q.c}60"></div>
        ${act > 0 ? `<div style="position:absolute;left:${needle}%;top:-4px;width:4px;height:14px;background:${q.c};border-radius:2px;transform:translateX(-50%);box-shadow:0 0 6px ${q.c}90"></div>` : ''}
      </div>
      <div class="q-hero-status" style="color:${statusColor}">${statusLabel}</div>
    </div>`;
  });
}

// â”€â”€ CLOCK â”€â”€
function tick() { document.getElementById('clock').textContent = new Date().toLocaleTimeString('en-US',{hour12:false}); }
setInterval(tick,1000); tick();

// â”€â”€ TICKER â”€â”€
const tickerItems = [
  ['S&P 500', 5280, +0.51], ['NASDAQ', 16820, +0.79], ['DOW', 39450, +0.34],
  ['RUSSELL 2K', 2085, +0.41], ['VIX', 18.4, +1.84], ['10Y YIELD', 4.28, -0.03],
  ['GOLD', 2340, +0.22], ['OIL (WTI)', 78.50, -0.38], ['USD/EUR', 1.085, +0.12],
];
const inner = tickerItems.map(([s,p,c])=>`<span>${s} <strong class="${c>=0?'t-pos':'t-neg'}">${c>=0?'â–²':'â–¼'} ${p>=100?'$':''}${Math.abs(p).toLocaleString()} (${c>0?'+':''}${c}%)</strong></span>`).join('');
document.getElementById('ticker').innerHTML = inner+inner;

// â”€â”€ SPARKLINES â”€â”€
function sparkline(id, data, color) {
  const el = document.getElementById(id);
  if (!el) return;
  const ctx = el.getContext('2d');
  const g = ctx.createLinearGradient(0,0,0,38);
  g=ctx.createLinearGradient(13,0,117,0);
  new Chart(ctx,{
    type:'line',
    data:{ labels:data.map((_,i)=>i), datasets:[{data,borderColor:color,borderWidth:1.5,fill:true,backgroundColor:g,pointRadius:0,tension:.4}]},
    options:{responsive:true,plugins:{legend:{display:false},tooltip:{enabled:false}},scales:{x:{display:false},y:{display:false}}}
  });
}

// â”€â”€ FINNHUB API â”€â”€
const FH_KEY = 'd6gsjjpr01qg85gvtg90d6gsjjpr01qg85gvtg9g';
async function fhQuote(symbol) {
  const r = await fetch(`https://finnhub.io/api/v1/quote?symbol=${encodeURIComponent(symbol)}&token=${FH_KEY}`);
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  const d = await r.json();
  if (!d.c || d.c === 0) throw new Error('No data for ' + symbol);
  return { current: d.c, prevClose: d.pc, change: d.d, changePct: d.dp, high: d.h, low: d.l, open: d.o };
}

// â”€â”€ MARKET STATUS (NYSE hours) â”€â”€
function updateMarketStatus() {
  const now = new Date();
  const et = new Date(now.toLocaleString('en-US', {timeZone:'America/New_York'}));
  const day = et.getDay();
  const h = et.getHours(), m = et.getMinutes();
  const mins = h * 60 + m;
  const isWeekday = day >= 1 && day <= 5;
  const preOpen = mins >= 240 && mins < 570;   // 4:00â€“9:30
  const isOpen = mins >= 570 && mins < 960;     // 9:30â€“16:00
  const afterHours = mins >= 960 && mins < 1200; // 16:00â€“20:00

  let status, badge, badgeCls, detail, dotColor;
  if (!isWeekday) {
    status = 'CLOSED'; badge = 'WEEKEND'; badgeCls = 'b-muted';
    detail = 'Markets reopen Monday 9:30 AM ET'; dotColor = 'var(--muted)';
  } else if (isOpen) {
    status = 'OPEN'; badge = 'LIVE'; badgeCls = 'b-green';
    const closeH = Math.floor((960 - mins) / 60), closeM = (960 - mins) % 60;
    detail = `Closes in ${closeH}h ${closeM}m`; dotColor = 'var(--green)';
  } else if (preOpen) {
    status = 'PRE-MARKET'; badge = 'PRE-MKT'; badgeCls = 'b-gold';
    const openH = Math.floor((570 - mins) / 60), openM = (570 - mins) % 60;
    detail = `Opens in ${openH}h ${openM}m`; dotColor = 'var(--gold)';
  } else if (afterHours) {
    status = 'AFTER HOURS'; badge = 'AFTER-HRS'; badgeCls = 'b-gold';
    detail = 'Extended hours trading'; dotColor = 'var(--gold)';
  } else {
    status = 'CLOSED'; badge = 'CLOSED'; badgeCls = 'b-muted';
    detail = 'Opens 9:30 AM ET'; dotColor = 'var(--muted)';
  }

  document.getElementById('mkt-status').textContent = status;
  document.getElementById('mkt-badge').className = 'badge ' + badgeCls;
  document.getElementById('mkt-badge').textContent = badge;
  document.getElementById('mkt-detail').textContent = detail;
  document.getElementById('header-mkt-label').textContent = 'MARKET ' + status;
  document.getElementById('header-dot').style.background = dotColor;
}
updateMarketStatus();
setInterval(updateMarketStatus, 30000);

// â”€â”€ LIVE VIX â”€â”€
function displayVIX(val, change, changePct) {
  document.getElementById('vix-val').textContent = val.toFixed(2);
  document.getElementById('vix-needle').style.left = Math.min(Math.max((val/50)*100,2),97)+'%';
  let regime,color,badge;
  if(val<12){regime='â—† Low Volatility';color='var(--green)';badge='CALM';}
  else if(val<20){regime='â¬¡ Normal Range';color='var(--blue)';badge='NORMAL';}
  else if(val<30){regime='â–² Elevated';color='var(--gold)';badge='ELEVATED';}
  else if(val<40){regime='âš  High Fear';color='#d98040';badge='FEAR';}
  else{regime='âš¡ Extreme Fear';color='var(--red)';badge='PANIC';}
  document.getElementById('vix-regime').textContent=regime;
  document.getElementById('vix-regime').style.color=color;
  const vb=document.getElementById('vix-badge');
  vb.textContent=badge;
  vb.className='badge '+(val<20?'b-blue':val<30?'b-gold':'b-red');
  // Change display
  const chgEl = document.getElementById('vix-change');
  if (change != null) {
    const pos = change >= 0;
    chgEl.className = 'stat-change ' + (pos ? 'neg' : 'pos'); // VIX up = bad
    chgEl.textContent = `${pos?'â–²':'â–¼'} ${Math.abs(change).toFixed(2)}  ${pos?'+':''}${changePct.toFixed(1)}%`;
  }
}

async function fetchVIX() {
  const yahooUrl = 'https://query1.finance.yahoo.com/v8/finance/chart/%5EVIX?range=5d&interval=1d';
  const proxies = [
    { url: `https://corsproxy.io/?url=${encodeURIComponent(yahooUrl)}`, wrapped: false },
    { url: `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(yahooUrl)}`, wrapped: false },
  ];
  for (const proxy of proxies) {
    try {
      const r = await fetch(proxy.url);
      if (!r.ok) continue;
      const raw = await r.json();
      const data = proxy.wrapped ? JSON.parse(raw.contents) : raw;
      const result = data.chart.result[0];
      const closes = result.indicators.quote[0].close.filter(v => v != null);
      const current = result.meta.regularMarketPrice || closes[closes.length - 1];
      const prev = result.meta.chartPreviousClose || (closes.length > 1 ? closes[closes.length - 2] : current);
      const change = current - prev;
      const changePct = prev ? (change / prev * 100) : 0;
      displayVIX(current, change, changePct);
      return true;
    } catch(e) { console.warn('[LWP] VIX proxy attempt failed:', e.message); continue; }
  }
  console.warn('[LWP] VIX all sources failed');
  document.getElementById('vix-val').textContent = 'â€”';
  document.getElementById('vix-regime').textContent = 'Data unavailable';
  document.getElementById('vix-badge').textContent = 'OFFLINE';
  document.getElementById('vix-badge').className = 'badge b-muted';
  document.getElementById('vix-change').textContent = 'Could not reach data source';
  return false;
}
fetchVIX();
setInterval(fetchVIX, 120000);

// â”€â”€ LIVE S&P 500 â”€â”€
async function fetchSPY() {
  try {
    const q = await fhQuote('SPY');
    const pos = q.change >= 0;
    document.getElementById('spy-val').textContent = '$' + q.current.toFixed(2);
    document.getElementById('spy-badge').textContent = (pos ? '+' : '') + q.changePct.toFixed(2) + '%';
    document.getElementById('spy-badge').className = 'badge ' + (pos ? 'b-green' : 'b-red');
    document.getElementById('spy-change').className = 'stat-change ' + (pos ? 'pos' : 'neg');
    document.getElementById('spy-change').textContent = `${pos?'â–²':'â–¼'} $${Math.abs(q.change).toFixed(2)}  ${pos?'+':''}${q.changePct.toFixed(2)}%`;
    return true;
  } catch(e) {
    console.warn('[LWP] SPY fetch failed:', e.message);
    document.getElementById('spy-val').textContent = 'â€”';
    document.getElementById('spy-change').textContent = 'Data unavailable';
    document.getElementById('spy-badge').textContent = 'OFFLINE';
    document.getElementById('spy-badge').className = 'badge b-muted';
    return false;
  }
}
fetchSPY();
setInterval(fetchSPY, 120000);

// â”€â”€ FEAR & GREED (CNN) â”€â”€
function drawArc(s){
  const cv=document.getElementById('fgArc'),ctx=cv.getContext('2d');
  ctx.clearRect(0,0,130,70);
  ctx.beginPath(); ctx.arc(65,68,52,Math.PI,0,false);
  ctx.lineWidth=8; ctx.strokeStyle='#d0dce8'; ctx.stroke();
  const g=ctx.createLinearGradient(13,0,117,0);
  g=ctx.createLinearGradient(13,0,117,0);
  g.addColorStop(.5,'#c9a84c'); g.addColorStop(.7,'#7db8da'); g.addColorStop(1,'#4aad84');
  ctx.beginPath(); ctx.arc(65,68,52,Math.PI,Math.PI+(s/100)*Math.PI,false);
  ctx.lineWidth=8; ctx.strokeStyle=g; ctx.lineCap='round'; ctx.stroke();
}
function fgInfo(s){
  if(s<=25) return{zone:'Extreme Fear',c:'#d95f6b',b:'EXTREME FEAR',a:'Enter monitoring posture Â· Prepare allocation frameworks'};
  if(s<=45) return{zone:'Fear',         c:'#d98040',b:'FEAR',         a:'4 of 7 sub-indicators Â· Begin staged reallocation into Growth'};
  if(s<=55) return{zone:'Neutral',      c:'#c9a84c',b:'NEUTRAL',      a:'Recovery toward 40â€“50 Â· Confirm breadth Â· Trim defensive OW'};
  if(s<=75) return{zone:'Greed',        c:'#7db8da',b:'GREED',        a:'Monitor concentration Â· Stay positioned Â· Watch for reversal'};
  return           {zone:'Extreme Greed',c:'#4aad84',b:'EXTREME GREED',a:'Risk review Â· Assess Q4 concentration Â· Trim outsized positions'};
}
function displayFG(score) {
  const s = Math.round(score);
  const info = fgInfo(s);
  drawArc(s);
  document.getElementById('fg-val').textContent = s;
  document.getElementById('fg-val').style.color = info.c;
  document.getElementById('fg-zone').textContent = info.zone;
  document.getElementById('fg-zone').style.color = info.c;
  document.getElementById('fg-action').textContent = info.a;
  const fb = document.getElementById('fg-badge');
  fb.textContent = info.b;
  fb.className = 'badge ' + (s<=25?'b-red':s<=55?'b-gold':'b-green');
}

async function fetchFearGreed() {
  const fgUrl = 'https://production.dataviz.cnn.io/index/fearandgreed/graphdata/2025-01-01';
  const proxies = [
    `https://corsproxy.io/?url=${encodeURIComponent(fgUrl)}`,
    `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(fgUrl)}`,
  ];
  for (const proxyUrl of proxies) {
    try {
      const r = await fetch(proxyUrl);
      if (!r.ok) continue;
      const raw = await r.json();
      const data = raw.contents ? JSON.parse(raw.contents) : raw;
      if (data && data.fear_and_greed && data.fear_and_greed.score != null) {
        displayFG(data.fear_and_greed.score);
        return true;
      }
    } catch(e) { console.warn('[LWP] F&G proxy failed:', e.message); continue; }
  }
  console.warn('[LWP] F&G all sources failed');
  drawArc(0);
  document.getElementById('fg-val').textContent = 'â€”';
  document.getElementById('fg-zone').textContent = 'Data unavailable';
  document.getElementById('fg-action').textContent = 'Could not reach CNN Fear & Greed API';
  document.getElementById('fg-badge').textContent = 'OFFLINE';
  document.getElementById('fg-badge').className = 'badge b-muted';
  return false;
}
fetchFearGreed();
setInterval(fetchFearGreed, 300000);

// â”€â”€ PERFORMANCE & BENCHMARKS (unified panel) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Fetch Yahoo Finance data via CORS proxy â€” returns { startPrice, endPrice } for a range
// endPrice is ALWAYS the previous trading day's close (not intraday)
async function yahooReturn(symbol, range) {
  const yRange = { ytd:'ytd', '1y':'1y', '2y':'2y', '3y':'5y', '5y':'5y' }[range] || '1y';
  const interval = ['2y','3y','5y'].includes(range) ? '1wk' : '1d';
  const yUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?range=${yRange}&interval=${interval}`;
  const proxies = [
    `https://corsproxy.io/?url=${encodeURIComponent(yUrl)}`,
    `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(yUrl)}`
  ];
  for (const proxyUrl of proxies) {
    try {
      const r = await fetch(proxyUrl);
      if (!r.ok) continue;
      const raw = await r.json();
      const data = raw.contents ? JSON.parse(raw.contents) : raw;
      const result = data.chart.result[0];
      const meta = result.meta;
      const timestamps = result.timestamp || [];
      const closes = result.indicators.quote[0].close || [];

      // Use previous close (last completed trading day) â€” NOT live intraday
      // meta.previousClose = yesterday's close; meta.regularMarketPrice = live/current
      // If previousClose isn't available, fall back to last candle close in the data
      let endPrice = meta.previousClose;
      if (!endPrice || endPrice <= 0) {
        // Walk backwards through candles to find last valid close
        for (let i = closes.length - 1; i >= 0; i--) {
          if (closes[i] && closes[i] > 0) { endPrice = closes[i]; break; }
        }
      }
      if (!endPrice || endPrice <= 0) continue;

      let startPrice;
      if (range === 'ytd') {
        startPrice = meta.chartPreviousClose;
      } else if (range === '3y') {
        const threeYearsAgo = Date.now() / 1000 - (3 * 365.25 * 86400);
        let bestIdx = 0, bestDiff = Infinity;
        for (let i = 0; i < timestamps.length; i++) {
          const diff = Math.abs(timestamps[i] - threeYearsAgo);
          if (diff < bestDiff) { bestDiff = diff; bestIdx = i; }
        }
        startPrice = closes[bestIdx];
      } else {
        startPrice = meta.chartPreviousClose;
      }

      if (!startPrice || startPrice <= 0) continue;
      console.log(`[LWP] ${symbol} ${range}: start=${startPrice.toFixed(2)} end=${endPrice.toFixed(2)} (prev close) return=${(((endPrice/startPrice)-1)*100).toFixed(2)}%`);
      return { startPrice, endPrice };
    } catch(e) {
      console.warn(`[LWP] Yahoo return fetch failed for ${symbol} (${range}):`, e.message);
    }
  }
  return null;
}

// Compute annualized return from start/end prices and years
function annualizedReturn(startPrice, endPrice, years) {
  if (!startPrice || startPrice <= 0 || !endPrice) return null;
  if (years <= 0) return null;
  if (years <= 1) {
    // For periods <= 1 year, just show total return (not annualized)
    return ((endPrice / startPrice) - 1) * 100;
  }
  return (Math.pow(endPrice / startPrice, 1 / years) - 1) * 100;
}

// Get years for each period
function rangeYears(range) {
  switch(range) {
    case 'ytd': {
      const now = new Date();
      const jan1 = new Date(now.getFullYear(), 0, 1);
      return (now - jan1) / (365.25 * 86400000);
    }
    case '1y': return 1;
    case '2y': return 2;
    case '3y': return 3;
    case '5y': return 5;
    default: return 1;
  }
}

// Format a return value as colored HTML
function fmtReturn(val) {
  if (val == null) return '<span style="color:var(--muted)">â€”</span>';
  const cls = val > 0 ? 'pos' : val < 0 ? 'neg' : '';
  return `<span class="${cls}">${val > 0 ? '+' : ''}${val.toFixed(1)}%</span>`;
}

// Update a single row in the perf table
function updatePerfRow(rowIdx, cells) {
  const tbody = document.getElementById('perf-tbody');
  const tr = tbody.rows[rowIdx];
  if (!tr) return;
  // cells = { ytd, y1, y2, y3, y5 } â€” each is a number or null
  tr.cells[1].innerHTML = fmtReturn(cells.ytd);
  tr.cells[2].innerHTML = fmtReturn(cells.y1);
  tr.cells[3].innerHTML = fmtReturn(cells.y2);
  tr.cells[4].innerHTML = fmtReturn(cells.y3);
  tr.cells[5].innerHTML = fmtReturn(cells.y5);
}

// Fetch benchmark returns for a given ticker across all periods
async function fetchBenchmarkReturns(symbol) {
  const ranges = ['ytd', '1y', '2y', '3y', '5y'];
  const results = {};
  for (const range of ranges) {
    const ret = await yahooReturn(symbol, range);
    if (ret) {
      const years = rangeYears(range);
      results[range] = annualizedReturn(ret.startPrice, ret.endPrice, years);
    } else {
      results[range] = null;
    }
    await new Promise(r => setTimeout(r, 200)); // rate limit
  }
  return { ytd: results.ytd, y1: results['1y'], y2: results['2y'], y3: results['3y'], y5: results['5y'] };
}

// Load all benchmarks on page load
async function loadBenchmarks() {
  const benchmarks = [
    { symbol: 'ACWI', rowIdx: 1 },
    { symbol: 'SPY',  rowIdx: 2 },
    // 60/40 computed from SPY + AGG
    { symbol: 'AGG',  rowIdx: 4 },
  ];

  let spyReturns = null, aggReturns = null;

  for (const bm of benchmarks) {
    try {
      console.log(`[LWP] Fetching benchmark: ${bm.symbol}`);
      const ret = await fetchBenchmarkReturns(bm.symbol);
      updatePerfRow(bm.rowIdx, ret);
      if (bm.symbol === 'SPY') spyReturns = ret;
      if (bm.symbol === 'AGG') aggReturns = ret;
    } catch(e) {
      console.warn(`[LWP] Benchmark fetch failed for ${bm.symbol}:`, e.message);
      updatePerfRow(bm.rowIdx, { ytd: null, y1: null, y2: null, y3: null, y5: null });
    }
  }

  // Compute 60/40 blend from SPY and AGG
  if (spyReturns && aggReturns) {
    const blend = {};
    for (const k of ['ytd', 'y1', 'y2', 'y3', 'y5']) {
      if (spyReturns[k] != null && aggReturns[k] != null) {
        blend[k] = spyReturns[k] * 0.6 + aggReturns[k] * 0.4;
      } else {
        blend[k] = null;
      }
    }
    updatePerfRow(3, blend);
  }

  document.getElementById('perf-note').textContent = 'Benchmark returns based on prior trading day close. Annualized for periods over 1 year.';
}

// Parse portfolio performance from the Performance sheet
// Accepts Label | Value rows like: "YTD" | 4.2  or  "1 Year" | 11.8  or  "LWP 3Y" | 8.4
// Also looks for "Client" | "Name" row to populate presentation banner
function parsePerformance(perfRows) {
  const perf = { ytd: null, y1: null, y2: null, y3: null, y5: null, clientName: null };
  if (!perfRows || perfRows.length === 0) return perf;
  const patterns = {
    ytd: /ytd/i,
    y1:  /1\s*y(ear|r)?/i,
    y2:  /2\s*y(ear|r)?/i,
    y3:  /3\s*y(ear|r)?/i,
    y5:  /5\s*y(ear|r)?/i,
  };
  for (const row of perfRows) {
    if (!row || row.length < 2) continue;
    const label = String(row[0] || '').trim();
    const valStr = String(row[1] || '').trim();
    // Check for client name row
    if (/^client/i.test(label) && valStr && !perf.clientName) {
      perf.clientName = valStr;
      console.log(`[LWP] Client name: "${valStr}"`);
      continue;
    }
    const val = parseFloat(valStr.replace(/[^0-9.\-]/g, ''));
    if (!label || isNaN(val)) continue;
    for (const [key, regex] of Object.entries(patterns)) {
      if (regex.test(label) && perf[key] === null) {
        perf[key] = val;
        console.log(`[LWP] Performance: "${label}" â†’ ${key} = ${val}%`);
      }
    }
  }
  return perf;
}

// Display portfolio returns from Excel data
function loadPortfolioReturns(perfData) {
  const hasAny = ['ytd','y1','y2','y3','y5'].some(k => perfData[k] !== null);
  if (hasAny) {
    updatePerfRow(0, perfData);
    document.getElementById('perf-badge').textContent = 'LIVE DATA';
    const count = ['ytd','y1','y2','y3','y5'].filter(k => perfData[k] !== null).length;
    document.getElementById('perf-note').textContent =
      `LWP Portfolio returns from uploaded file (${count}/5 periods). Benchmarks as of prior close.`;
  }
  // Set client name for presentation mode
  if (perfData.clientName) {
    document.getElementById('client-name').textContent = perfData.clientName + ' â€” Portfolio Review';
  }
}

// Start loading benchmarks immediately
loadBenchmarks();

// â”€â”€ OLD CHART TABS REMOVED â”€â”€

// â”€â”€ FIVE QUADRANT MODEL â”€â”€ (empty state â€” shows target ranges, no allocations until upload)
const quadrants = [
  {n:'Q1', name:'Cash & Bonds',  role:'Preservation Â· Liquidity',    lo:1,  hi:5,  c:'#4a7fa5'},
  {n:'Q2', name:'Balanced',      role:'Income + Growth Anchor',       lo:10, hi:20, c:'#2d6a9f'},
  {n:'Q3', name:'Dividends',     role:'Income Â· Inflation Hedge',     lo:15, hi:25, c:'#1a7a4a'},
  {n:'Q4', name:'Growth',        role:'Capital Appreciation Engine',  lo:50, hi:60, c:'#0d3349'},
  {n:'Q5', name:'Alternatives',  role:'Low Correlation Â· Diversify',  lo:5,  hi:10, c:'#6b9fc2'},
];
const ql = document.getElementById('quadrant-list');
quadrants.forEach(q=>{
  const barScale = 30;
  const barLeft  = (q.lo / barScale * 100).toFixed(1);
  const barWidth = ((q.hi - q.lo) / barScale * 100).toFixed(1);

  ql.innerHTML+=`<div class="q-row">
    <div class="q-badge" style="background:${q.c}15;color:${q.c};border:1px solid ${q.c}35">${q.n}</div>
    <div style="min-width:0;flex:1">
      <div class="q-name">${q.name}</div>
      <div class="q-role">${q.role}</div>
      <div style="margin-top:5px;position:relative;height:4px;background:var(--border);border-radius:2px;overflow:visible">
        <div style="position:absolute;left:${barLeft}%;width:${barWidth}%;height:100%;background:${q.c}30;border-radius:2px;border:1px solid ${q.c}50"></div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:3px;font-family:'DM Mono',monospace;font-size:11px;color:var(--muted)">
        <span>${q.lo}%</span><span style="color:${q.c};font-weight:700">â€”</span><span>${q.hi}%</span>
      </div>
    </div>
    <div style="text-align:right;flex-shrink:0;padding-left:8px">
      <div style="font-family:'DM Mono',monospace;font-size:12px;font-weight:700;color:var(--muted);letter-spacing:.5px">AWAITING DATA</div>
      <div style="font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);margin-top:2px">tgt ${q.lo}â€“${q.hi}%</div>
    </div>
  </div>`;
});

// â”€â”€ WATCHLIST â”€â”€
const watchData = [
  {s:'META',n:'Meta Platforms',   p:511.22,c:+1.89},
  {s:'GOOGL',n:'Alphabet Inc.',   p:172.18,c:+0.44},
  {s:'AMD', n:'Adv. Micro Devices',p:182.63,c:-0.73},
  {s:'PLTR',n:'Palantir Tech.',   p:28.44, c:+5.12},
  {s:'CRM', n:'Salesforce',       p:305.21,c:-0.31},
];
const wl = document.getElementById('watchlist');
watchData.forEach(w=>{
  const pos=w.c>=0;
  wl.innerHTML+=`<div class="watch-item">
    <div><div class="w-sym">${w.s}</div><div class="w-name">${w.n}</div></div>
    <div style="text-align:right">
      <div class="w-price">$${w.p.toLocaleString()}</div>
      <div class="w-chg ${pos?'pos':'neg'}">${pos?'â–²':'â–¼'} ${Math.abs(w.c)}%</div>
    </div>
  </div>`;
});

// â”€â”€ HOLDINGS â”€â”€ (empty state â€” populated on file upload)
const staticQMeta = {
  Q1:{label:'Q1 â€” Cash & Bonds',  c:'#4a7fa5'},
  Q2:{label:'Q2 â€” Balanced',      c:'#2d6a9f'},
  Q3:{label:'Q3 â€” Dividends',     c:'#1a7a4a'},
  Q4:{label:'Q4 â€” Growth',        c:'#0d3349'},
  Q5:{label:'Q5 â€” Alternatives',  c:'#6b9fc2'},
};
function rsInfo(s){ return s>=4.6?{l:'BUY',cls:'rs-buy'}:s>=3.6?{l:'ADD',cls:'rs-add'}:s>=2.1?{l:'HOLD',cls:'rs-hold'}:s>=1.1?{l:'TRIM',cls:'rs-trim'}:{l:'SELL',cls:'rs-sell'}; }
document.getElementById('holdings-tbody').innerHTML = `<tr><td colspan="8" style="text-align:center;padding:40px 20px;color:var(--muted);font-size:14px;font-family:'Raleway',sans-serif">Upload a holdings file to view positions</td></tr>`;

// â”€â”€ DORSEY WRIGHT LINK â”€â”€ opens security page in new tab (requires NDW subscription)
function dwLink(ticker) {
  return `https://dorseywright.nasdaq.com/chart/index/trend/${encodeURIComponent(ticker)}`;
}

// â”€â”€ NEWS â”€â”€
const news = [
  {src:'Bloomberg',hl:'Fed minutes signal caution on rate cuts as inflation stays sticky above 3%',     time:'2h ago',tag:'NEUTRAL',tc:'tag-neut'},
  {src:'Reuters',  hl:'NVIDIA surges on blockbuster data center demand, raises Q1 guidance',           time:'3h ago',tag:'BULLISH',tc:'tag-bull'},
  {src:'WSJ',      hl:'Bitcoin approaches $70K as institutional inflows into spot ETFs accelerate',    time:'4h ago',tag:'BULLISH',tc:'tag-bull'},
  {src:'CNBC',     hl:'Tesla faces renewed pressure as EV demand growth slows in key markets',         time:'5h ago',tag:'BEARISH',tc:'tag-bear'},
  {src:'FT',       hl:'Big Tech earnings season broadly beats; AI spend driving capex surge',          time:'6h ago',tag:'BULLISH',tc:'tag-bull'},
  {src:"Barron's", hl:"S&P 500 consolidates near highs; analysts eye 5,800 target by mid-year",       time:'8h ago',tag:'NEUTRAL',tc:'tag-neut'},
];
const ng = document.getElementById('news-grid');
news.forEach(n=>{
  ng.innerHTML+=`<div class="news-item">
    <div class="news-src">${n.src}</div>
    <div class="news-hl">${n.hl}</div>
    <div style="display:flex;align-items:center;justify-content:space-between">
      <span class="news-tag ${n.tc}">${n.tag}</span>
      <span class="news-time">${n.time}</span>
    </div>
  </div>`;
});

// â”€â”€ VIX + F&G: live fetching handled above â”€â”€

// â”€â”€ OLD CHART TABS REMOVED (replaced by perf-tabs handler above) â”€â”€

let portBase = 0;
// No random animation â€” portfolio value only updates from file upload


// â”€â”€ XLSX + LIVE PRICE UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const QUAD_RANGES = {
  Q1:{ lo:1,  hi:5,  name:'Cash & Bonds',  role:'Preservation Â· Liquidity',    c:'#4a7fa5' },
  Q2:{ lo:10, hi:20, name:'Balanced',       role:'Income + Growth Anchor',      c:'#2d6a9f' },
  Q3:{ lo:15, hi:25, name:'Dividends',      role:'Income Â· Inflation Hedge',    c:'#1a7a4a' },
  Q4:{ lo:50, hi:60, name:'Growth',         role:'Capital Appreciation Engine', c:'#0d3349' },
  Q5:{ lo:5,  hi:10, name:'Alternatives',   role:'Low Correlation Â· Diversify', c:'#6b9fc2' },
};
const qMeta = {
  Q1:{label:'Q1 â€” Cash & Bonds',  c:'#4a7fa5'},
  Q2:{label:'Q2 â€” Balanced',      c:'#2d6a9f'},
  Q3:{label:'Q3 â€” Dividends',     c:'#1a7a4a'},
  Q4:{label:'Q4 â€” Growth',        c:'#0d3349'},
  Q5:{label:'Q5 â€” Alternatives',  c:'#6b9fc2'},
  UNKNOWN:{label:'â€” Unassigned',  c:'#486a82'},
};

function showStatus(msg, type) {
  const el = document.getElementById('upload-status');
  el.innerHTML = msg;
  el.className = 'upload-status ' + type;
  el.style.display = 'block';
}

// â”€â”€ Parse XLSX or CSV â€” requires header row: Ticker | Quadrant | Quantity | Price
function parseFile(arrayBuffer, filename) {
  const ext = filename.split('.').pop().toLowerCase();
  let rows, perfRows = [];
  if (ext === 'xlsx' || ext === 'xls') {
    if (typeof XLSX === 'undefined') throw new Error('SheetJS not loaded â€” try refreshing.');
    const wb = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });
    rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header:1, defval:'' });
    // Check for a "Performance" sheet
    const perfSheet = wb.SheetNames.find(n => /perf/i.test(n));
    if (perfSheet) {
      perfRows = XLSX.utils.sheet_to_json(wb.Sheets[perfSheet], { header:1, defval:'' });
      console.log(`[LWP] Found Performance sheet: "${perfSheet}" with ${perfRows.length} rows`);
    }
  } else {
    const text = new TextDecoder().decode(arrayBuffer);
    rows = text.trim().split(/\r?\n/).map(l => l.split(',').map(c => c.replace(/['"]/g,'').trim()));
  }
  if (rows.length < 2) throw new Error('File appears empty.');

  // Scan first 6 rows to find the header row
  let headerIdx = -1;
  for (let i = 0; i < Math.min(6, rows.length); i++) {
    const vals = rows[i].map(v => String(v).trim().toLowerCase());
    if (vals.some(v => ['ticker','symbol','sym','security'].includes(v))) { headerIdx = i; break; }
  }
  if (headerIdx === -1) throw new Error('No header row found. Row 1 must contain: Ticker | Quadrant | Quantity | Price');

  const h = rows[headerIdx].map(v => String(v).trim().toLowerCase());
  const tCol      = h.findIndex(v => v.includes('ticker') || v.includes('symbol') || v === 'sym' || v === 'security');
  const qCol      = h.findIndex(v => v.includes('quad'));
  const sharesCol = h.findIndex(v => v.includes('qty') || v.includes('quant') || v.includes('share') || v.includes('unit') || v.includes('held'));
  const priceCol  = h.findIndex(v => v.includes('price') || v.includes('close') || v === 'last' || v === 'px');
  const rsCol     = h.findIndex(v => {
    if (v.includes('share') || v.includes('qty') || v.includes('quant') || v.includes('unit') || v.includes('held')) return false;
    return v === 'rs' || v.includes('rs score') || v.includes('rs ') || v.startsWith('rs') || v.includes('relative strength') || v.includes('rel strength');
  });

  if (tCol      === -1) throw new Error('Missing "Ticker" column.');
  if (qCol      === -1) throw new Error('Missing "Quadrant" column.');
  if (sharesCol === -1) throw new Error('Missing "Quantity" column.');
  if (priceCol  === -1) throw new Error('Missing "Price" column.');

  const positions = [];
  for (let i = headerIdx + 1; i < rows.length; i++) {
    const row    = rows[i];
    const ticker = String(row[tCol]      || '').trim().toUpperCase();
    // Normalize quadrant: "Q1", "q1", "1", "Quadrant 1", "Q 1" â†’ "Q1"
    const rawQuad = String(row[qCol] || '').trim();
    const digits  = rawQuad.replace(/[^0-9]/g, '');
    const quad    = digits ? 'Q' + digits[0] : rawQuad.toUpperCase().replace(/\s/g,'');
    const qty     = parseFloat(String(row[sharesCol] || '').replace(/[^0-9.-]/g,''));
    const price   = parseFloat(String(row[priceCol]  || '').replace(/[^0-9.-]/g,''));
    const rsRaw   = rsCol !== -1 ? parseFloat(String(row[rsCol] || '').replace(/[^0-9.-]/g,'')) : NaN;
    const rs      = (!isNaN(rsRaw) && rsRaw >= 0 && rsRaw <= 6) ? rsRaw : null;
    if (!ticker || ['TOTAL','CASH',''].includes(ticker)) continue;
    if (!qty   || isNaN(qty)   || qty   <= 0) continue;
    if (!price || isNaN(price) || price <= 0) continue;
    positions.push({ ticker, quad: QUAD_RANGES[quad] ? quad : 'UNKNOWN', qty, price, rawQuad, rs });
  }
  if (positions.length === 0) throw new Error('No valid data rows found after the header.');
  return { positions, perfRows };
}

// â”€â”€ Rebuild all dashboard panels
function refreshDashboard(rows) {
  const totalValue = rows.reduce((s, r) => s + r.value, 0);

  document.getElementById('port-val').textContent = '$' + Math.round(totalValue).toLocaleString();
  document.getElementById('port-badge').textContent = 'LIVE DATA';
  document.getElementById('port-badge').className = 'badge b-green';
  document.getElementById('port-change').textContent = rows.length + ' positions loaded from file';
  document.getElementById('port-change').className = 'stat-change pos';

  const quadTotals = {Q1:0,Q2:0,Q3:0,Q4:0,Q5:0,UNKNOWN:0};
  rows.forEach(r => { quadTotals[r.quad] = (quadTotals[r.quad]||0) + r.value; });

  // Store for presentation mode quadrant hero
  lastQuadTotals = quadTotals;
  lastTotalValue = totalValue;
  if (presentMode) buildQuadrantHero();

  const ql = document.getElementById('quadrant-list');
  ql.innerHTML = '';
  ['Q1','Q2','Q3','Q4','Q5'].forEach(qk => {
    const q    = QUAD_RANGES[qk];
    const act  = totalValue > 0 ? (quadTotals[qk] / totalValue * 100) : 0;
    const actR = (Math.round(act * 10) / 10).toFixed(1);
    const inBand   = act >= q.lo && act <= q.hi;
    const nearEdge = inBand && (act - q.lo < 2 || q.hi - act < 2);
    const statusLabel = !inBand ? 'OUT OF BAND' : nearEdge ? 'NEAR EDGE' : 'IN BAND';
    const statusColor = !inBand ? '#c0392b'     : nearEdge ? '#c9a84c'   : '#4aad84';
    const barScale = 30;
    const barLeft  = (q.lo / barScale * 100).toFixed(1);
    const barWidth = ((q.hi - q.lo) / barScale * 100).toFixed(1);
    const needle   = Math.min(Math.max((act / barScale * 100), 1), 99).toFixed(1);
    const qVal     = '$' + Math.round(quadTotals[qk]).toLocaleString();
    ql.innerHTML += `<div class="q-row">
      <div class="q-badge" style="background:${q.c}18;color:${q.c};border:1px solid ${q.c}40">${qk}</div>
      <div style="min-width:0;flex:1">
        <div class="q-name">${q.name} <span style="font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);font-weight:400">${qVal}</span></div>
        <div class="q-role">${q.role}</div>
        <div style="margin-top:5px;position:relative;height:4px;background:var(--border);border-radius:2px;overflow:visible">
          <div style="position:absolute;left:${barLeft}%;width:${barWidth}%;height:100%;background:${q.c}2a;border-radius:2px;border:1px solid ${q.c}55"></div>
          <div style="position:absolute;left:${needle}%;top:-3px;width:3px;height:10px;background:${q.c};border-radius:1px;transform:translateX(-50%);box-shadow:0 0 5px ${q.c}80;transition:left 0.8s ease"></div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:3px;font-family:'DM Mono',monospace;font-size:11px;color:var(--muted)">
          <span>${q.lo}%</span><span style="color:${q.c};font-weight:700">${actR}% actual</span><span>${q.hi}%</span>
        </div>
      </div>
      <div style="text-align:right;flex-shrink:0;padding-left:8px">
        <div style="font-family:'DM Mono',monospace;font-size:12px;font-weight:700;color:${statusColor};letter-spacing:.5px">${statusLabel}</div>
        <div style="font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);margin-top:2px">tgt ${q.lo}\u2013${q.hi}%</div>
      </div>
    </div>`;
  });

  const tb = document.getElementById('holdings-tbody');
  tb.innerHTML = '';
  const sorted = [...rows].sort((a,b) =>
    ['Q1','Q2','Q3','Q4','Q5','UNKNOWN'].indexOf(a.quad) - ['Q1','Q2','Q3','Q4','Q5','UNKNOWN'].indexOf(b.quad)
  );
  let lastQ = null;
  sorted.forEach(h => {
    const qc = (qMeta[h.quad]||qMeta.UNKNOWN).c;
    if (h.quad !== lastQ) {
      tb.innerHTML += `<tr style="background:${qc}18"><td colspan="8" style="padding:5px 8px 4px;font-size:12px;font-weight:800;letter-spacing:2px;color:${qc};text-transform:uppercase;border-bottom:2px solid ${qc}60">${(qMeta[h.quad]||qMeta.UNKNOWN).label}</td></tr>`;
      lastQ = h.quad;
    }
    const pct   = ((h.value/totalValue)*100).toFixed(1)+'%';
    const price = '$'+h.price.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
    const val   = '$'+Math.round(h.value).toLocaleString();
    const rs    = (h.rs != null && h.rs >= 0) ? rsInfo(h.rs) : null;
    const rsScoreDisplay = (h.rs != null && h.rs >= 0)
      ? `<span class="rs ${rsInfo(h.rs).cls}" style="font-size:13px;padding:4px 10px;border-radius:3px;font-weight:700">${h.rs % 1 === 0 ? h.rs.toFixed(0) : h.rs.toFixed(2)}</span>`
      : 'â€”';
    tb.innerHTML += `<tr>
      <td><div class="t-sym">${h.ticker}</div></td>
      <td><span style="font-family:'DM Mono',monospace;font-size:13px;font-weight:700;color:${qc};background:${qc}12;padding:2px 6px;border-radius:2px;border:1px solid ${qc}30">${h.quad}</span></td>
      <td style="font-family:'DM Mono',monospace;font-size:14px;color:var(--muted);text-align:center">${pct}</td>
      <td>${price}</td>
      <td>\u2014</td>
      <td>${val}</td>
      <td>${rsScoreDisplay}</td>
      <td>${rs ? `<span class="rs ${rs.cls}" style="cursor:pointer" onclick="window.open('${dwLink(h.ticker)}','_blank')" title="View ${h.ticker} on Nasdaq Dorsey Wright">${rs.l}</span>` : 'â€”'}</td>
    </tr>`;
  });

  document.querySelector('.holdings-section .card-label .badge').textContent =
    rows.length + ' POSITIONS \u00b7 5 QUADRANTS';

  const lu = document.getElementById('last-updated');
  lu.textContent = '\u2191 Updated ' + new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
  lu.style.display = 'block';

  const unknown = rows.filter(r=>r.quad==='UNKNOWN');
  if (unknown.length) {
    const detail = unknown.map(r=>`${r.ticker} (read: "${r.rawQuad||'?'}")`).join(', ');
    showStatus(`âš  ${rows.length} positions Â· $${Math.round(totalValue).toLocaleString()} total<br>Unrecognized quadrant for: ${detail}<br><small>Quadrant column must contain Q1, Q2, Q3, Q4, or Q5</small>`, 'error');
  } else {
    document.getElementById('clear-btn').style.display = 'inline-block';
    showStatus(`âœ“ ${rows.length} positions loaded Â· $${Math.round(totalValue).toLocaleString()} total portfolio value`, 'success');
  }
}

// â”€â”€ Clear uploaded data, restore demo state
function clearUpload() {
  document.getElementById('upload-badge').textContent = 'CSV / XLSX';
  document.getElementById('clear-btn').style.display = 'none';
  const st = document.getElementById('upload-status');
  st.style.display = 'none';
  document.getElementById('last-updated').style.display = 'none';
  document.getElementById('csv-input').value = '';
  // Reload page to restore demo data cleanly
  location.reload();
}

// â”€â”€ Main handler â€” file only, no network calls
function handleFile(file) {
  if (!file) return;
  document.getElementById('upload-badge').textContent = file.name.length>18 ? file.name.slice(0,16)+'\u2026' : file.name;
  showStatus('\u27f3 Reading file\u2026', 'success');
  file.arrayBuffer().then(buf => {
    try {
      const parsed = parseFile(buf, file.name);
      const rows = parsed.positions.map(p => ({ ticker:p.ticker, quad:p.quad, qty:p.qty, price:p.price, value:p.price*p.qty, rawQuad:p.rawQuad, rs:p.rs }));
      refreshDashboard(rows);
      // Parse and display portfolio performance from Performance sheet
      const perfData = parsePerformance(parsed.perfRows);
      loadPortfolioReturns(perfData);
    } catch(err) {
      showStatus('\u2715 ' + err.message, 'error');
      console.error(err);
    }
  });
}

// â”€â”€ Wire up file input (browse button)
document.getElementById('csv-input').addEventListener('change', e => {
  if (e.target.files[0]) handleFile(e.target.files[0]);
  e.target.value = ''; // reset so same file can be re-uploaded
});

// â”€â”€ Wire up drag and drop on the zone (NOT the file input)
const dropZone = document.getElementById('upload-zone');

dropZone.addEventListener('dragenter', e => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragover',  e => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', e => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); });
dropZone.addEventListener('drop',      e => {
  e.preventDefault();
  e.stopPropagation();
  dropZone.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file) handleFile(file);
});

</script>
</body>
</html>
